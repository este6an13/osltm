## October 23rd, 2025

### Summary

A prototype script, `compute_realtime_od`, was developed to compute an **Origin–Destination (OD) matrix** in real time using the **next check-in heuristic**.
This serves as an exploratory implementation to test the **feasibility of real-time OD estimation** from check-in data.
The OD matrix is continuously updated in real time and periodically cleaned to retain only the most recent 15 minutes of data per station, maintaining a rolling snapshot of current travel patterns.
No data persistence has been implemented yet, as the historical OD schema remains undefined.

### Method and Implementation

1. **Algorithm Overview**

   * Reads validation (check-in) data in chronological order, simulating real-time ingestion.
   * For each card (`Numero_Tarjeta`), stores its **most recent check-in** as `(timestamp, station)` in memory.
   * When the same card reappears with a **different station**, it is assumed that:
     $$
     \text{Trip: } S_1 \to S_2
     $$
     has occurred, where $S_1$ is the previous check-in station.
   * The count for that OD pair $(S_1, S_2)$ is incremented in a **time-indexed structure**.

2. **Temporal Window and Cleanup**

   * The algorithm maintains only the last 15 minutes of check-ins per station in memory to reflect the current real-time state of the system.
   * Every 15 minutes, old entries are discarded, and updated probabilities $P(S_2 | S_1)$ are computed for each origin station:
     $$
     P(S_2 | S_1) = \frac{\text{count}(S_1, S_2)}{\sum_{S'_2} \text{count}(S_1, S'_2)}
     $$
   * This window size (15 min) matches the estimation granularity used for $\hat{\lambda}$ computations in the database.
   * In a real-time production implementation, it would also be necessary to remove unmatched check-ins (cards without a corresponding next check-in) after a longer retention period — for example, 72 hours.

3. **Example**

   * Suppose in the 6:00–6:14 AM window:

     * Two check-ins occur at station **A**, at 6:00 and 6:05.
     * The same cards later appear at **B** (17:00) and **C** (18:00).
   * Then, for that window:
     $$
     P(B|A) = 0.5, \quad P(C|A) = 0.5
     $$
     This probability distribution represents the estimated OD pattern from A to {B, C}.

4. **Temporal Granularity**

   * The current implementation uses **15-minute windows**.
   * Future work includes defining whether:

     * OD matrices should align with $\hat{\lambda}$ estimation granularity (currently also 15 min), or
     * they require finer or coarser temporal resolution.

5. **Persistence and Seasonality**

   * No persistent OD storage is implemented yet.
   * If historical OD matrices are later recorded, they may follow the **same seasonal structure** assumed for $\hat{\lambda}$ estimation:

     * e.g., OD patterns vary by day of week, week of month, and month.
     * Example: a Tuesday in the second week of August may have a different OD matrix than a Thursday of that same week.

### Decisions

1. The OD matrix will initially be computed **in real time only**, without persistent storage.
2. Temporal granularity is currently fixed at **15-minute intervals**, consistent with $\hat{\lambda}$ estimation windows.
3. The algorithm retains only the most recent 15 minutes of check-in data per station to reflect the current state of the system rather than historical patterns.


### Assumptions to Validate

1. The **next check-in heuristic** is a valid proxy for identifying a passenger’s destination.
2. OD patterns $P(S_2 | S_1, t)$ are **time-dependent** and vary throughout the day.
3. A **15-minute temporal window** is sufficiently granular to capture changes in travel patterns.
4. OD matrices exhibit **seasonal behavior** similar to $\hat{\lambda}$ estimates (by weekday, week, and month).
5. Conditional distribution $P(S_2|S_1, t)$ changes with time $t$ (time window, day of week, week of month, month).
6. Cleaning data older than 15 minutes does not significantly distort short-term OD probability estimates.
