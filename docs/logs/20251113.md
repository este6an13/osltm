## **November 13th, 2025**

### **Summary**

Implemented the new **V2 data model** replacing the old *Estimates* table with the improved **Counts15Min** table. This new schema stores raw **15-minute counts** instead of normalized 5-minute means, and additionally includes **1-minute variance for check-ins**. This enables computing **time-window-specific overdispersion**, which was not possible with the V1 data model.

Developed the script **`simulate_with_counts_15min`** to generate simulated ridership data using the new V2 schema, and added a companion notebook demonstrating usage.

Next, implemented two new analytical scripts:

1. **`compute_intensity_from_mvf`**
   Computes the **mean value function (MVF)** from daily cumulative counts, smooths it via splines, and differentiates it to obtain the **intensity function** λ(t).

2. **`compute_intensity_from_data`**
   Computes **intensity directly from raw counts** by averaging the per-minute rates across days, smoothing via splines, and integrating the result to reconstruct the MVF.

Also added **`simulate_with_smooth_intensity`**, which evaluates the performance of the direct-intensity estimation method (`compute_intensity_from_data`). It does not simulate new stochastic paths but instead evaluates accuracy and error metrics using the smoothed intensity curves.

Accompanying notebooks were added to visualize the smoothing behavior, MVF reconstruction, intensity curves, and performance metrics.

Initial evaluation on multiple stations shows:

* **R² scores typically exceed 0.8**, comparable to the earlier V1 simulation outputs.
* **Overdispersion is detected in >95% of time windows**, supporting the use of the **Negative Binomial (NB)** model instead of Poisson for check-ins.
* The smooth-intensity approach performs similarly to the MVF-based approach, suggesting it could be a viable modeling alternative.

---

### **Method and Implementation**

* Structured the V2 pipeline around **Counts15Min**, treating each 15-minute window as a raw observation.
* For intensity estimation:

  * Aligned all days on a common time grid (HHMM format).
  * Computed per-minute rates by dividing counts by 15.
  * Averaged across days to obtain **E[λ(t)]**.
  * Applied a **smoothing spline** with a tunable smoothing factor.
  * Integrated the smoothed intensity to recover the mean value function.
* For the MVF-first approach:

  * Computed cumulative counts for each day.
  * Averaged across days to obtain **m(t)**.
  * Applied spline smoothing to **m(t)**.
  * Differentiated m(t) to obtain λ(t).
* Integrated evaluation metrics (R², error curves) using the existing simulation evaluation framework.

---

### **Decisions**

* Kept the **HHMM time format**, but performed spline fitting on a **uniform index grid** to avoid distortions from irregular HHMM spacing.
* Decided to compute intensity using **both**:

  1. MVF → differentiate
  2. Direct intensity → integrate
     This allows comparing two estimation pipelines and selecting the most stable one.
* Chose **Negative Binomial** as the default model for check-ins based on consistent evidence of overdispersion.
* Retained Poisson for check-outs, since the dataset lacks variance information for exits.

---

### **Assumptions to Validate**

* The spline smoothing factor is appropriate across stations; station-specific tuning may be needed.
* The direct-intensity approach remains stable for stations with low or irregular ridership patterns.
* Overdispersion estimates based on 1-minute variance are reliable and not biased by measurement or system artifacts.
* The reconstructed MVF from smoothed intensity is accurate enough for simulation use in downstream modules.
* The NB model’s performance advantage outweighs its slight reduction in R² compared to Poisson in some cases.
